<!DOCTYPE html>
<html lang="pt">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Usando Django MPTT em APIs REST</title>

        <!-- Bootstrap Core CSS -->
        <link href="http://localhost:8000/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://localhost:8000/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://localhost:8000/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
		<link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700|Open+Sans:300,300i,400,400i,600,600i,700,800|Roboto:300,400,500,700" rel="stylesheet">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Nesse post vamos ensinar como usar o Django MPTT juntamente com Django REST Framework para listar e persistir dados hierárquicos.">

        <meta name="author" content="Gilson Filho">

        <meta name="tags" content="python">
        <meta name="tags" content="linguagem">
        <meta name="tags" content="desenvolvimento">
        <meta name="tags" content="django">
        <meta name="tags" content="rest">
        <meta name="tags" content="mptt">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Desbravando Django">

	<meta property="og:type" content="article">
            <meta property="article:author" content="http://localhost:8000/author/gilson-filho.html">
	<meta property="og:url" content="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/">
	<meta property="og:title" content="Usando Django MPTT em APIs REST">
	<meta property="article:published_time" content="2016-06-09 11:59:00-03:00">
            <meta property="og:description" content="Nesse post vamos ensinar como usar o Django MPTT juntamente com Django REST Framework para listar e persistir dados hierárquicos.">

            <meta property="og:image" content="http://localhost:8000//images/covers/api_back.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
					<li><a class="navbar-brand" href="http://localhost:8000/">Início</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/images/covers/api_back.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Usando Django MPTT em APIs REST</h1>
                        <span class="meta">Posted by
                                <a href="http://localhost:8000/author/gilson-filho.html">Gilson Filho</a>
                             on Qui 09 junho 2016
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">

    <!-- Post Content -->
    <article>
        <p>Olá pessoal,</p>
<p>Essa semana precisei fazer com que criasse uma simples feature para categorias e sub-categorias, mas para uma API REST. De forma convencional com Django usei o <a href="https://github.com/django-mptt/django-mptt">Django MPTT</a>, e ele trás algumas boas features para serem persistidas e renderizadas com os templates do framework, mas aproveitei para fazer uns testes com o Django REST Framework. Assim, vamos aprender a preparar a serialização desse tipo de estrutura de dados, tanto para consulta como para persistência.</p>
<h2>Criando o projeto</h2>
<p>Vamos criar uma simples aplicação de cadastro de categorias e subcategorias, nada tão complexo. Assim vamos criar o projeto Django, e instalar as dependências necessárias:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span>$ pip install djangorestframework django-mptt
</pre></div>


<p>Configure para que sua aplicação use as bibliotecas:</p>
<div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>

    <span class="s1">&#39;mptt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>


<p>Feito isso, vamos criar a nossa aplicação.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span>$ python manage.py startapp core
<span class="o">(</span>categories<span class="o">)</span>$ mv core categories/
</pre></div>


<p>Registre essa nova aplicação, para iniciarmos o nosso desenvolvimento:</p>
<div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>

    <span class="s1">&#39;mptt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>

    <span class="s1">&#39;categories.core&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>


<h2>Preparando o modelo</h2>
<p>Vamos criar um modelo chamado <strong>Category</strong> que irá representar o que precisamos:</p>
<h2>Preparando o modelo</h2>
<p>Vamos criar um modelo chamado <strong>Category</strong> que irá representar o que precisamos. Ele precisa herdar da classe <em>MPTTModel</em>. Veja a <a href="http://django-mptt.github.io/django-mptt">documentação</a> para mais informações:</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">mptt.models</span> <span class="kn">import</span> <span class="n">MPTTModel</span><span class="p">,</span> <span class="n">TreeForeignKey</span>


<span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">MPTTModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Representa as categorias e</span>
<span class="sd">    subcategorias do sistema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">TreeForeignKey</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">MPTTMeta</span><span class="p">:</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s2">&quot;categories&quot;</span>
        <span class="n">order_insertion_by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>


<p>O que fizemos é nada mais que criar um novo modelo. Ele possui o atributo <em>name</em> que representa o nome da categoria e o atributo <em>parent</em> que vai ser uma chave estrangeira do mesmo tipo de modelo, para associar as sub-categorias que são do mesmo tipo.</p>
<p>Para aplicar ao nosso banco, gere a migração e a execute:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span>$ python manage.py makemigrations
Migrations <span class="k">for</span> <span class="s1">&#39;core&#39;</span>:
  0001_initial.py:
    - Create model Category

<span class="o">(</span>categories<span class="o">)</span>$ python manage.py migrate
Operations to perform:
  Apply all migrations: contenttypes, auth, sessions, core, admin
Running migrations:
  Rendering model states... DONE
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length...p OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null...y OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying core.0001_initial... OK
  Applying sessions.0001_initial... OK
</pre></div>


<h2>Criando serializer e views</h2>
<p>Feito a nossa classe, vamos criar a classe serializer que vai tratar os dados vindos do usuário como provindas do servidor.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,)</span>
</pre></div>


<p>Vamos criar a view que vai listar e persistir as categorias e subcategorias da nossa API. Vamos usar os generics do Django REST.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>

<span class="kn">from</span> <span class="nn">categories.core.serializers</span> <span class="kn">import</span> <span class="n">CategorySerializer</span>
<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">CategoryView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>


<span class="k">class</span> <span class="nc">CategoryDetailView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>
</pre></div>


<p>E depois crie uma endpoint para a nossa view em <code>categories/urls.py</code>:</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">categories.core.views</span> <span class="kn">import</span> <span class="n">CategoryView</span><span class="p">,</span> <span class="n">CategoryDetailView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>

    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^categories/(?P&lt;pk&gt;[0-9]+)$&#39;</span><span class="p">,</span> <span class="n">CategoryDetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^categories/&#39;</span><span class="p">,</span> <span class="n">CategoryView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</pre></div>


<p>Agora com tudo implementado e configurado, vamos rodar o servidor.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span>$ python manage.py runserver
</pre></div>


<h2>Criando categoria e subcategoria</h2>
<p>Vamos criar uma categoria. Vamos usar o <a href="https://github.com/jkbrzt/httpie">httpie</a> que é um belo CLI HTTP para fazer esses testes.</p>
<div class="highlight"><pre><span></span>http POST http://localhost:8000/categories/ <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;Category Bar&quot;</span>

HTTP/1.0 <span class="m">201</span> Created
Allow: GET, POST, HEAD, OPTIONS
Content-Type: application/json
Date: Thu, <span class="m">09</span> Jun <span class="m">2016</span> 15:29:38 GMT
Server: WSGIServer/0.2 CPython/3.5.1
Vary: Accept, Cookie
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;id&quot;</span>: 1,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Category Bar&quot;</span>
<span class="o">}</span>
</pre></div>


<p>Agora vamos atualizar o nosso serializer para que ele possa aceitar subcategorias, mas de forma opcional, porque se criarmos outra categorias e tornar o children por padrão obrigatório conforme o Django REST Framework faz, vai gerar erro de validação.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span>
        <span class="n">queryset</span><span class="o">=</span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">,)</span>
</pre></div>


<p>Vamos criar outra categoria que vai definir nosso registro anterior como subcategoria:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span> $ http POST http://localhost:8000/categories/ <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;Category Foo&quot;</span> children:<span class="o">=[</span>1<span class="o">]</span>
HTTP/1.0 <span class="m">201</span> Created
Allow: GET, POST, HEAD, OPTIONS
Content-Type: application/json
Date: Thu, <span class="m">09</span> Jun <span class="m">2016</span> 15:39:09 GMT
Server: WSGIServer/0.2 CPython/3.5.1
Vary: Accept, Cookie
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;children&quot;</span>: <span class="o">[</span>
        1
    <span class="o">]</span>,
    <span class="s2">&quot;id&quot;</span>: 2,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Category Foo&quot;</span>
<span class="o">}</span>
</pre></div>


<p>Vendo na interface do Django REST temos isso:</p>
<p><img alt="Listando Categorias" src="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/images/django-mptt-api-rest/category_list.png" /></p>
<h1>Detalhando subcategorias</h1>
<p>Vemos os filhos das categorias retornam somente a identificação do registro, e não é isso que queremos. Vamos fazer com que retorna além do <em>id</em> retorne também o seu nome.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">SubCategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">SubCategorySerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">,)</span>
</pre></div>


<p>Vendo na interface do Django REST temos isso:</p>
<p><img alt="Listando Categorias" src="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/images/django-mptt-api-rest/category_list_with_nested_serializer.png" /></p>
<h1>Customizando serialização</h1>
<p>Vamos supor que queremos mudar o nome <em>children</em> para <em>subcategories</em>. Podemos fazer dessa forma:</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">SubCategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">subcategories</span> <span class="o">=</span> <span class="n">SubCategorySerializer</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&quot;children&quot;</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;subcategories&quot;</span><span class="p">,)</span>
</pre></div>


<p>Vendo na interface do Django REST temos isso:</p>
<p><img alt="Listando Categorias" src="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/images/django-mptt-api-rest/category_list_with_custom_field.png" /></p>
<p>O problema que na nossa subcategoria, vemos que ele continua <em>children</em> já que não alteramos no serializer <code>SubCategorySerializer</code>. Você até poderia mudar, mas fica limitado a profundidade da estrutura, já que tiver mais de 20 níveis, teria que ficar mudando toda hora, e isso não é bom.</p>
<h2>Criando um novo field</h2>
<p>O que podemos fazer é criar um field chamado de <code>RecursiveField</code> em que ele vai serializar a partir do serializer do parente. Assim pode ter quandos níveis quiser, que ele vai fazer isso e fora que podemos eliminar o <code>SubCategorySerializer</code>, e mudar o nome do campo sem repetições.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ObjectDoesNotExist</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">RecursiveField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">BaseSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cria instancia do serializer parente e retorna os dados</span>
<span class="sd">    serializados.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">ParentSerializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">__class__</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ParentSerializer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">ParentSerializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">__class__</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="n">ParentSerializer</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">model</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Objeto {0} não encontrado&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">Model</span><span class="p">()</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>


<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">subcategories</span> <span class="o">=</span> <span class="n">RecursiveField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&quot;children&quot;</span><span class="p">,</span>
                                   <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;subcategories&quot;</span><span class="p">,)</span>
</pre></div>


<p>Vendo na interface do Django REST temos isso:</p>
<p><img alt="Listando Categorias" src="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/images/django-mptt-api-rest/category_list_with_recursive_field.png" /></p>
<h2>Inserindo subcategorias</h2>
<p>Vamos criar uma nova categoria, em que ela vai estar associada a nossa categoria <em>Category Bar</em>.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span>$ http POST http://localhost:8000/categories/ <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;Category Foobar&quot;</span>
HTTP/1.0 <span class="m">201</span> Created
Allow: GET, POST, HEAD, OPTIONS
Content-Type: application/json
Date: Thu, <span class="m">09</span> Jun <span class="m">2016</span> 16:13:16 GMT
Server: WSGIServer/0.2 CPython/3.5.1
Vary: Accept, Cookie
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;id&quot;</span>: 3,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Category Foobar&quot;</span>,
    <span class="s2">&quot;subcategories&quot;</span>: <span class="o">[]</span>
<span class="o">}</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span>$ http PUT http://localhost:5000/categories/1 subcategories:<span class="o">=[</span>5<span class="o">]</span>
HTTP/1.0 <span class="m">200</span> OK
Allow: GET, PUT, PATCH, HEAD, OPTIONS
Content-Type: application/json
Date: Thu, <span class="m">09</span> Jun <span class="m">2016</span> 18:02:20 GMT
Server: WSGIServer/0.2 CPython/3.5.1
Vary: Accept, Cookie
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;id&quot;</span>: 1,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Category Bar&quot;</span>,
    <span class="s2">&quot;subcategories&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;id&quot;</span>: 5,
            <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Category Foobar&quot;</span>,
            <span class="s2">&quot;subcategories&quot;</span>: <span class="o">[]</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>


<p>Vendo na interface do Django REST temos isso:</p>
<p><img alt="Listando Categorias" src="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/images/django-mptt-api-rest/category_list_after_updated.png" /></p>
<p>Vendo agora que temos três nívels na nossa hierarquia, o campo que criamos para o serializer evita repetição de código.</p>
<h2>Refatorando nossa consulta</h2>
<p>Agora que já implementamos nossos endpoints, vamos refatorar a consulta das categorias, já que ele deve retornar da forma correta, que é a partir das categorias-pai, e encadeado pelos filhos.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>

<span class="kn">from</span> <span class="nn">categories.core.serializers</span> <span class="kn">import</span> <span class="n">CategorySerializer</span>
<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">CategoryView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">root_nodes</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>


<span class="k">class</span> <span class="nc">CategoryDetailView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>
</pre></div>


<p>O django-mptt oferece um manager próprio, que possui os tipos de consutas que precisamos. Aqui usamos o <code>root_nodes()</code> para listar as categorias retornando somente as categorias principais, que são base para as subcategorias.</p>
<p>Vendo na interface do Django REST temos isso:</p>
<p><img alt="Listando Categorias" src="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/images/django-mptt-api-rest/category_with_queryset_custom.png" /></p>
<h2>Solução Alternativa</h2>
<p>Acima é uma solução em que pode fazer as customização que necessitar, mas se não vai passar disso, recomendo que use o <a href="https://github.com/heywbj/django-rest-framework-recursive">django-rest-framework-recursive</a> que oferece uma serialização recursiva. Além da serialização no estilo de árvore, oferece alguns outros.</p>
<p>Assim vamos refatorar a solução que fizemos, deixando com menos código. Primeiro vamos instalar e configurar.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>categories<span class="o">)</span>$ pip install djangorestframework-recursive
</pre></div>


<div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>

    <span class="s1">&#39;mptt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework_recursive&#39;</span><span class="p">,</span>

    <span class="s1">&#39;categories.core&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>


<p>Vamos refatorar o nosso <code>serializers.py</code> para usar o campo recursivo.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">rest_framework_recursive.fields</span> <span class="kn">import</span> <span class="n">RecursiveField</span>

<span class="kn">from</span> <span class="nn">categories.core.models</span> <span class="kn">import</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">subcategories</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ListSerializer</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&quot;children&quot;</span><span class="p">,</span>
                                               <span class="n">child</span><span class="o">=</span><span class="n">RecursiveField</span><span class="p">())</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;subcategories&quot;</span><span class="p">,)</span>
</pre></div>


<p>Vendo na interface do Django REST temos isso:</p>
<p><img alt="Listando Categorias" src="http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/images/django-mptt-api-rest/category_list_with_app_recursive.png" /></p>
<h2>Conclusão</h2>
<p>Assim, vemos que não é tão complicado tratar esse tipo de estrutura de dados com o Django REST e o Django MPTT. Com o app que citei anteriormente, ele lista perfeitamente, mas no caso de persistência encontrei alguns problemas na validação, assim quando encontrar a solução irei atualizar esse post.</p>
<p>Repositório do projeto do post: <a href="https://github.com/gilsondevlabs/categories-api-rest/">https://github.com/gilsondevlabs/categories-api-rest</a></p>
<p>Espero que tenha gostado. Até mais!</p>
    </article>

        <div class="tags">
            <p>tags: <a href="http://localhost:8000/tag/python.html">python</a>, <a href="http://localhost:8000/tag/linguagem.html">linguagem</a>, <a href="http://localhost:8000/tag/desenvolvimento.html">desenvolvimento</a>, <a href="http://localhost:8000/tag/django.html">django</a>, <a href="http://localhost:8000/tag/rest.html">rest</a>, <a href="http://localhost:8000/tag/mptt.html">mptt</a></p>
        </div>

    <hr>

        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'desbravandodjango';
                var disqus_identifier = '2016/06/09/usando-django-mptt-em-apis-rest/';
                var disqus_url = 'http://localhost:8000/2016/06/09/usando-django-mptt-em-apis-rest/';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//desbravandodjango.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="http://github.com/desbravandodjango">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://twitter.com/desbravandodjango">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://localhost:8000/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://localhost:8000/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="http://localhost:8000/theme/js/clean-blog.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'desbravandodjango';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>